<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Application de gestion pour banque alimentaire">
  <meta name="theme-color" content="#2E5CFF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Banque Alim">
  
  <title>Banque Alimentaire - Fontenay</title>
  
  <link rel="manifest" href="manifest.json">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    
    #root {
      min-height: 100vh;
    }

    /* Am√©lioration des inputs sur mobile */
    input, select, textarea, button {
      font-size: 16px; /* √âvite le zoom automatique sur iOS */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const normalizeString = (str) => {
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    };

    const areNamesEquivalent = (name1, name2) => {
      return normalizeString(name1) === normalizeString(name2);
    };

    // ========== HELPER API ==========
    const API_URL = 'https://banque-alimentaire-backend.onrender.com/api';

    const apiCall = async (endpoint, options = {}) => {
      const token = localStorage.getItem('ba_token');
      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          ...(token && { 'Authorization': `Bearer ${token}` }),
        },
      };
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...defaultOptions,
        ...options,
        headers: { ...defaultOptions.headers, ...options.headers },
      });
      if (response.status === 401) {
        localStorage.removeItem('ba_token');
        localStorage.removeItem('ba_logged_in');
        window.location.reload();
      }
      return response;
    };

    function BanqueAlimentaireApp({ onLogout }) {
      // ========== R√îLE ET UTILISATEUR ==========
      const userRole = localStorage.getItem('ba_role') || 'user';
      const isAdmin = userRole === 'admin';
      const userName = localStorage.getItem('ba_user_name') || 'Utilisateur';

      // ========== INVENTAIRE (connect√© √† l'API) ==========
      const [inventory, setInventory] = useState([]);
      const [inventoryLoading, setInventoryLoading] = useState(true);
      const [inventorySaving, setInventorySaving] = useState(false);
      
      // ========== CARTONS (connect√© √† l'API) ==========
      const [boxTemplates, setBoxTemplates] = useState([]);
      const [templatesLoading, setTemplatesLoading] = useState(true);
      
      // ========== DISTRIBUTIONS (connect√© √† l'API) ==========
      const [distributions, setDistributions] = useState([]);
      const [distributionsLoading, setDistributionsLoading] = useState(true);
      
      const [activeTab, setActiveTab] = useState('inventory');
      const [newItem, setNewItem] = useState({ item_name: '', quantity: 0, unit: 'unit√©s', price: 0 });
      const [editingItem, setEditingItem] = useState(null);
      
      const [newTemplate, setNewTemplate] = useState({ template_name: '', description: '', items: [] });
      const [newTemplateItem, setNewTemplateItem] = useState({ item_name: '', quantity: 0 });
      
      const [newDistribution, setNewDistribution] = useState({ 
        template_id: '', 
        distribution_date: '', 
        box_count: 0,
        notes: '' 
      });
      
      const [selectedDistribution, setSelectedDistribution] = useState(null);
      const [distributionNeeds, setDistributionNeeds] = useState([]);
      
      const [menuOpen, setMenuOpen] = useState(false);
      
      // ========== FACTURES (connect√© √† l'API) ==========
      const [invoices, setInvoices] = useState([]);
      const [invoicesLoading, setInvoicesLoading] = useState(true);
      
      const [showInvoices, setShowInvoices] = useState(false);
      
      const [newInvoice, setNewInvoice] = useState({
        supplier: '',
        invoice_number: '',
        invoice_date: '',
        file: null,
        fileData: null,
        items: [],
        total: 0,
        notes: ''
      });
      
      const [newInvoiceItem, setNewInvoiceItem] = useState({
        item_name: '',
        quantity: 0,
        unit: 'unit√©s',
        price: 0
      });

      // ========== CHARGER L'INVENTAIRE DEPUIS L'API ==========
      const loadInventory = async () => {
        try {
          setInventoryLoading(true);
          const response = await apiCall('/inventory');
          if (response.ok) {
            const data = await response.json();
            // Adapter les donn√©es de l'API au format frontend
            const formatted = data.map(item => ({
              id: item.id,
              item_name: item.item_name,
              quantity: parseFloat(item.quantity),
              unit: item.unit || 'unit√©s',
              price: parseFloat(item.price_per_unit) || 0
            }));
            setInventory(formatted);
          }
        } catch (err) {
          console.error('Erreur chargement inventaire:', err);
        } finally {
          setInventoryLoading(false);
        }
      };

      // ========== CHARGER LES CARTONS DEPUIS L'API ==========
      const loadTemplates = async () => {
        try {
          setTemplatesLoading(true);
          const response = await apiCall('/templates');
          if (response.ok) {
            const data = await response.json();
            // Adapter les donn√©es pour le frontend
            const formatted = data.map(t => ({
              id: t.id,
              template_name: t.template_name,
              description: t.description || '',
              items: t.items || []
            }));
            setBoxTemplates(formatted);
          }
        } catch (err) {
          console.error('Erreur chargement templates:', err);
        } finally {
          setTemplatesLoading(false);
        }
      };

      // ========== CHARGER LES DISTRIBUTIONS DEPUIS L'API ==========
      const loadDistributions = async () => {
        try {
          setDistributionsLoading(true);
          const response = await apiCall('/distributions');
          if (response.ok) {
            const data = await response.json();
            setDistributions(data);
          }
        } catch (err) {
          console.error('Erreur chargement distributions:', err);
        } finally {
          setDistributionsLoading(false);
        }
      };

      // ========== CHARGER LES FACTURES DEPUIS L'API ==========
      const loadInvoices = async () => {
        try {
          setInvoicesLoading(true);
          const response = await apiCall('/invoices');
          if (response.ok) {
            const data = await response.json();
            setInvoices(data);
          }
        } catch (err) {
          console.error('Erreur chargement factures:', err);
        } finally {
          setInvoicesLoading(false);
        }
      };

      // ========== CHARGER TOUTES LES DONN√âES AU D√âMARRAGE ==========
      useEffect(() => {
        loadInventory();
        loadTemplates();
        loadDistributions();
        loadInvoices();
      }, []);

      const addToInventory = async () => {
        if (!newItem.item_name || newItem.quantity <= 0) {
          alert('Veuillez remplir le nom et la quantit√©');
          return;
        }

        setInventorySaving(true);
        try {
          // V√©rifier si l'article existe d√©j√†
          const existingItem = inventory.find(item => 
            areNamesEquivalent(item.item_name, newItem.item_name)
          );

          if (existingItem) {
            // Mettre √† jour l'article existant
            const newQuantity = existingItem.quantity + parseFloat(newItem.quantity);
            const response = await apiCall(`/inventory/${existingItem.id}`, {
              method: 'PUT',
              body: JSON.stringify({
                item_name: existingItem.item_name,
                quantity: newQuantity,
                unit: existingItem.unit,
                price_per_unit: newItem.price > 0 ? newItem.price : existingItem.price
              }),
            });

            if (response.ok) {
              await loadInventory();
              setNewItem({ item_name: '', quantity: 0, unit: 'unit√©s', price: 0 });
              alert(`‚úÖ Quantit√© mise √† jour : ${existingItem.item_name} = ${newQuantity} ${existingItem.unit}`);
            } else {
              const error = await response.json();
              alert('‚ùå ' + (error.error || 'Erreur de mise √† jour'));
            }
          } else {
            // Cr√©er un nouvel article
            const response = await apiCall('/inventory', {
              method: 'POST',
              body: JSON.stringify({
                item_name: newItem.item_name,
                quantity: parseFloat(newItem.quantity),
                unit: newItem.unit,
                price_per_unit: newItem.price || 0
              }),
            });

            if (response.ok) {
              await loadInventory();
              setNewItem({ item_name: '', quantity: 0, unit: 'unit√©s', price: 0 });
              alert('‚úÖ Article ajout√© !');
            } else {
              const error = await response.json();
              alert('‚ùå ' + (error.error || 'Erreur d\'ajout'));
            }
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur de connexion au serveur');
        } finally {
          setInventorySaving(false);
        }
      };

      const updateInventoryItem = async (id, quantity) => {
        const item = inventory.find(i => i.id === id);
        if (!item) return;

        setInventorySaving(true);
        try {
          const response = await apiCall(`/inventory/${id}`, {
            method: 'PUT',
            body: JSON.stringify({
              item_name: item.item_name,
              quantity: parseFloat(quantity),
              unit: item.unit,
              price_per_unit: item.price
            }),
          });

          if (response.ok) {
            await loadInventory();
            setEditingItem(null);
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur de mise √† jour'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur de connexion');
        } finally {
          setInventorySaving(false);
        }
      };

      const deleteInventoryItem = async (id) => {
        if (!confirm('Supprimer cet article ?')) return;

        setInventorySaving(true);
        try {
          const response = await apiCall(`/inventory/${id}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            await loadInventory();
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur de suppression'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur de connexion');
        } finally {
          setInventorySaving(false);
        }
      };

      const addToNewTemplate = () => {
        if (newTemplateItem.item_name && newTemplateItem.quantity > 0) {
          const existingIndex = newTemplate.items.findIndex(item =>
            areNamesEquivalent(item.item_name, newTemplateItem.item_name)
          );

          if (existingIndex !== -1) {
            const updatedItems = [...newTemplate.items];
            updatedItems[existingIndex].quantity += parseFloat(newTemplateItem.quantity);
            setNewTemplate({ ...newTemplate, items: updatedItems });
            alert(`‚úÖ Quantit√© mise √† jour`);
          } else {
            setNewTemplate({
              ...newTemplate,
              items: [...newTemplate.items, { ...newTemplateItem }]
            });
          }
          
          setNewTemplateItem({ item_name: '', quantity: 0 });
        }
      };

      const removeFromNewTemplate = (index) => {
        setNewTemplate({
          ...newTemplate,
          items: newTemplate.items.filter((_, i) => i !== index)
        });
      };

      const saveBoxTemplate = async () => {
        if (!newTemplate.template_name || newTemplate.items.length === 0) {
          alert('Nom et articles requis');
          return;
        }

        try {
          const response = await apiCall('/templates', {
            method: 'POST',
            body: JSON.stringify({
              template_name: newTemplate.template_name,
              description: newTemplate.description || '',
              items: newTemplate.items
            }),
          });

          if (response.ok) {
            await loadTemplates();
            setNewTemplate({ template_name: '', description: '', items: [] });
            alert('‚úÖ Mod√®le cr√©√© !');
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur cr√©ation'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur connexion');
        }
      };

      const deleteBoxTemplate = async (id) => {
        if (!confirm('Supprimer ce mod√®le ?')) return;

        try {
          const response = await apiCall(`/templates/${id}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            await loadTemplates();
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur suppression'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur connexion');
        }
      };

      const createDistribution = async () => {
        if (!newDistribution.template_id || !newDistribution.distribution_date || newDistribution.box_count <= 0) {
          alert('Remplir tous les champs');
          return;
        }

        try {
          const template = boxTemplates.find(t => t.id === parseInt(newDistribution.template_id));
          const response = await apiCall('/distributions', {
            method: 'POST',
            body: JSON.stringify({
              template_id: parseInt(newDistribution.template_id),
              template_name: template ? template.template_name : '',
              distribution_date: newDistribution.distribution_date,
              box_count: parseInt(newDistribution.box_count),
              notes: newDistribution.notes || '',
              status: 'planned'
            }),
          });

          if (response.ok) {
            await loadDistributions();
            setNewDistribution({ template_id: '', distribution_date: '', box_count: 0, notes: '' });
            alert('‚úÖ Distribution planifi√©e !');
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur cr√©ation'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur connexion');
        }
      };

      const viewDistributionNeeds = (distributionId) => {
        const dist = distributions.find(d => d.id === distributionId);
        const template = boxTemplates.find(t => t.id === parseInt(dist.template_id));
        
        if (!template) {
          alert('Mod√®le de carton introuvable');
          return;
        }
        
        const needs = template.items.map(templateItem => {
          const inventoryItem = inventory.find(invItem =>
            areNamesEquivalent(invItem.item_name, templateItem.item_name)
          );
          
          const total_needed = templateItem.quantity * dist.box_count;
          const available = inventoryItem ? inventoryItem.quantity : 0;
          const missing = Math.max(0, total_needed - available);
          const price = inventoryItem ? inventoryItem.price || 0 : 0;
          const missingCost = missing * price;
          
          return {
            item_name: templateItem.item_name,
            quantity_per_box: templateItem.quantity,
            total_needed,
            available,
            missing,
            sufficient: missing === 0,
            price,
            missingCost
          };
        });
        
        setDistributionNeeds(needs);
        setSelectedDistribution(distributionId);
      };

      const deleteDistribution = async (id) => {
        if (!confirm('Supprimer cette distribution ?')) return;

        try {
          const response = await apiCall(`/distributions/${id}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            await loadDistributions();
            setSelectedDistribution(null);
            setDistributionNeeds([]);
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur suppression'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur connexion');
        }
      };

      const clearAllData = () => {
        if (confirm('‚ö†Ô∏è Effacer TOUTES les donn√©es ?')) {
          if (confirm('Vraiment s√ªr ?')) {
            localStorage.clear();
            setInventory([]);
            setBoxTemplates([]);
            setDistributions([]);
            alert('‚úÖ Donn√©es effac√©es');
          }
        }
      };


      // NOUVELLE FONCTION : G√©n√©rer PDF du carton
      const generateBoxPDF = (template) => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          doc.setFontSize(22);
          doc.setFont(undefined, 'bold');
          doc.text('Banque Alimentaire de Fontenay', 105, 20, { align: 'center' });
          
          doc.setFontSize(18);
          doc.text('Modele: ' + template.template_name, 105, 35, { align: 'center' });
          
          if (template.description) {
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(template.description, 105, 45, { align: 'center' });
          }
          
          doc.setLineWidth(0.5);
          doc.line(20, 50, 190, 50);
          
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.text('Article', 25, 60);
          doc.text('Quantite', 150, 60);
          
          doc.setLineWidth(0.3);
          doc.line(20, 63, 190, 63);
          
          let yPos = 73;
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          
          template.items.forEach((item) => {
            if (yPos > 270) {
              doc.addPage();
              yPos = 20;
            }
            
            doc.rect(22, yPos - 4, 4, 4);
            doc.text(item.item_name, 30, yPos);
            doc.text(String(item.quantity), 155, yPos);
            
            yPos += 10;
          });
          
          doc.setFontSize(10);
          doc.setFont(undefined, 'italic');
          const today = new Date().toLocaleDateString('fr-FR');
          doc.text('Genere le ' + today, 105, 285, { align: 'center' });
          
          doc.save('carton-' + template.template_name + '.pdf');
          alert('PDF telecharge !');
        } catch (error) {
          console.error('Erreur PDF:', error);
          alert('Erreur lors de la generation du PDF');
        }
      };

      // ========== EXPORT PDF INVENTAIRE ==========
      const exportInventoryToPDF = () => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Titre
          doc.setFontSize(20);
          doc.setFont(undefined, 'bold');
          doc.text('Banque Alimentaire - Inventaire', 105, 20, { align: 'center' });
          
          // Date
          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');
          doc.text('Genere le ' + new Date().toLocaleDateString('fr-FR'), 105, 30, { align: 'center' });
          
          // Stats
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('Statistiques :', 20, 45);
          
          doc.setFont(undefined, 'normal');
          doc.text('Nombre d\'articles : ' + inventory.length, 20, 55);
          const totalValue = inventory.reduce((sum, item) => sum + (item.quantity * (item.price || 0)), 0);
          doc.text('Valeur totale : ' + totalValue.toFixed(2) + ' EUR', 20, 62);
          
          // Tableau des articles
          doc.setFont(undefined, 'bold');
          doc.text('Articles :', 20, 75);
          
          let y = 85;
          doc.setFontSize(10);
          
          // Headers
          doc.setFont(undefined, 'bold');
          doc.text('Article', 20, y);
          doc.text('Quantite', 100, y);
          doc.text('Prix', 140, y);
          doc.text('Total', 170, y);
          
          y += 7;
          doc.setFont(undefined, 'normal');
          
          // Lignes
          inventory.forEach(item => {
            if (y > 270) {
              doc.addPage();
              y = 20;
            }
            
            doc.text((item.item_name || '').substring(0, 30), 20, y);
            doc.text(item.quantity + ' ' + (item.unit || ''), 100, y);
            doc.text((item.price || 0).toFixed(2) + ' EUR', 140, y);
            doc.text((item.quantity * (item.price || 0)).toFixed(2) + ' EUR', 170, y);
            
            y += 7;
          });
          
          // Sauvegarder
          doc.save('inventaire_' + new Date().toISOString().split('T')[0] + '.pdf');
          alert('‚úÖ PDF genere !');
        } catch (error) {
          console.error('Erreur PDF:', error);
          alert('Erreur lors de la generation du PDF');
        }
      };

      // ========== EXPORT PDF DISTRIBUTION ==========
      const exportDistributionToPDF = (distribution) => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          const template = boxTemplates.find(t => t.id === parseInt(distribution.template_id));
          
          doc.setFontSize(18);
          doc.setFont(undefined, 'bold');
          doc.text('Distribution - ' + (template?.template_name || distribution.template_name || 'Sans nom'), 105, 20, { align: 'center' });
          
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text('Date : ' + new Date(distribution.distribution_date).toLocaleDateString('fr-FR'), 20, 40);
          doc.text('Nombre de cartons : ' + distribution.box_count, 20, 50);
          
          if (template && template.items) {
            doc.setFont(undefined, 'bold');
            doc.text('Contenu par carton :', 20, 65);
            
            let y = 75;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            template.items.forEach(item => {
              doc.text('- ' + item.item_name + ' : ' + item.quantity, 25, y);
              y += 7;
            });
            
            // Total n√©cessaire
            y += 10;
            doc.setFont(undefined, 'bold');
            doc.text('Total necessaire :', 20, y);
            
            y += 10;
            doc.setFont(undefined, 'normal');
            
            template.items.forEach(item => {
              const totalNeeded = item.quantity * distribution.box_count;
              doc.text(item.item_name + ' : ' + totalNeeded, 25, y);
              y += 7;
            });
          }
          
          doc.save('distribution_' + distribution.distribution_date + '.pdf');
          alert('‚úÖ PDF genere !');
        } catch (error) {
          console.error('Erreur PDF:', error);
          alert('Erreur lors de la generation du PDF');
        }
      };


      // FONCTIONS FACTURES
      const handleInvoiceFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setNewInvoice({
              ...newInvoice,
              file: file.name,
              fileData: event.target.result
            });
          };
          reader.readAsDataURL(file);
        }
      };

      const addToNewInvoice = () => {
        if (newInvoiceItem.item_name && newInvoiceItem.quantity > 0 && newInvoiceItem.price > 0) {
          const existingIndex = newInvoice.items.findIndex(item =>
            areNamesEquivalent(item.item_name, newInvoiceItem.item_name)
          );

          let updatedItems;
          if (existingIndex !== -1) {
            updatedItems = [...newInvoice.items];
            updatedItems[existingIndex].quantity += parseFloat(newInvoiceItem.quantity);
            updatedItems[existingIndex].price = parseFloat(newInvoiceItem.price);
            alert('‚úÖ Quantit√© mise √† jour');
          } else {
            updatedItems = [...newInvoice.items, { ...newInvoiceItem }];
          }
          
          const total = updatedItems.reduce((sum, item) => 
            sum + (item.quantity * item.price), 0
          );
          
          setNewInvoice({
            ...newInvoice,
            items: updatedItems,
            total: total
          });
          
          setNewInvoiceItem({ item_name: '', quantity: 0, unit: 'unit√©s', price: 0 });
        }
      };

      const removeFromNewInvoice = (index) => {
        const updatedItems = newInvoice.items.filter((_, i) => i !== index);
        const total = updatedItems.reduce((sum, item) => 
          sum + (item.quantity * item.price), 0
        );
        setNewInvoice({
          ...newInvoice,
          items: updatedItems,
          total: total
        });
      };

      const saveInvoice = async () => {
        if (!newInvoice.supplier || !newInvoice.invoice_date || newInvoice.items.length === 0) {
          alert('Remplir tous les champs');
          return;
        }

        try {
          const response = await apiCall('/invoices', {
            method: 'POST',
            body: JSON.stringify({
              supplier: newInvoice.supplier,
              invoice_number: newInvoice.invoice_number || '',
              invoice_date: newInvoice.invoice_date,
              items: newInvoice.items,
              total: newInvoice.total,
              notes: newInvoice.notes || '',
              file_name: newInvoice.file || null,
              file_data: newInvoice.fileData || null
            }),
          });

          if (response.ok) {
            await loadInvoices();
            setNewInvoice({
              supplier: '',
              invoice_number: '',
              invoice_date: '',
              file: null,
              fileData: null,
              items: [],
              total: 0,
              notes: ''
            });
            setShowInvoices(false);
            alert('‚úÖ Facture enregistr√©e !');
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur enregistrement'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur connexion');
        }
      };

      const deleteInvoice = async (id) => {
        if (!confirm('Supprimer cette facture ?')) return;

        try {
          const response = await apiCall(`/invoices/${id}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            await loadInvoices();
          } else {
            const error = await response.json();
            alert('‚ùå ' + (error.error || 'Erreur suppression'));
          }
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur connexion');
        }
      };

      const addInvoiceToStock = async (invoice) => {
        if (!confirm(`Ajouter les ${invoice.items.length} articles au stock ?`)) return;

        setInventorySaving(true);
        try {
          for (const invoiceItem of invoice.items) {
            const existingItem = inventory.find(item =>
              areNamesEquivalent(item.item_name, invoiceItem.item_name)
            );

            if (existingItem) {
              // Mettre √† jour l'article existant
              await apiCall(`/inventory/${existingItem.id}`, {
                method: 'PUT',
                body: JSON.stringify({
                  item_name: existingItem.item_name,
                  quantity: existingItem.quantity + parseFloat(invoiceItem.quantity),
                  unit: existingItem.unit,
                  price_per_unit: invoiceItem.price
                }),
              });
            } else {
              // Cr√©er un nouvel article
              await apiCall('/inventory', {
                method: 'POST',
                body: JSON.stringify({
                  item_name: invoiceItem.item_name,
                  quantity: parseFloat(invoiceItem.quantity),
                  unit: invoiceItem.unit,
                  price_per_unit: invoiceItem.price
                }),
              });
            }
          }

          // Mettre √† jour la facture pour marquer qu'elle a √©t√© ajout√©e au stock
          await apiCall(`/invoices/${invoice.id}`, {
            method: 'PUT',
            body: JSON.stringify({
              ...invoice,
              added_to_stock: true
            }),
          });

          await loadInventory();
          await loadInvoices();
          
          alert('‚úÖ Stock mis √† jour !');
        } catch (err) {
          console.error('Erreur:', err);
          alert('‚ùå Erreur lors de l\'ajout au stock');
        } finally {
          setInventorySaving(false);
        }
      };

      return (
        <div style={{
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)',
          fontFamily: '"Inter", sans-serif',
          paddingBottom: '20px'
        }}>
          <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
          
          <div style={{ maxWidth: '100%', margin: '0 auto' }}>
            <header style={{
              padding: '15px 20px',
              color: 'white',
              background: 'rgba(0,0,0,0.1)',
              marginBottom: '20px',
              display: 'flex',
              alignItems: 'center',
              gap: '15px'
            }}>
              <button
                onClick={() => setMenuOpen(!menuOpen)}
                style={{
                  padding: '10px',
                  background: 'rgba(255,255,255,0.25)',
                  color: 'white',
                  border: '2px solid rgba(255,255,255,0.5)',
                  borderRadius: '10px',
                  cursor: 'pointer',
                  fontSize: '24px',
                  lineHeight: '1',
                  width: '48px',
                  height: '48px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0
                }}
              >
                {menuOpen ? '‚úï' : '‚ò∞'}
              </button>
              
              <div style={{ flex: 1 }}>
                <h1 style={{ fontSize: '1.5rem', fontWeight: '800', marginBottom: '5px' }}>
                  Banque Alimentaire
                </h1>
                <p style={{ fontSize: '0.8rem', opacity: 0.9 }}>
                  Fontenay-sous-Bois
                </p>
              </div>
            </header>

            {menuOpen && (
              <>
                <div 
                  onClick={() => setMenuOpen(false)}
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    zIndex: 998
                  }}
                />
                <div style={{
                  position: 'fixed',
                  top: '80px',
                  left: '20px',
                  background: 'white',
                  borderRadius: '12px',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                  zIndex: 999,
                  minWidth: '220px',
                  overflow: 'hidden'
                }}>
                  {/* Affichage utilisateur et r√¥le */}
                  <div style={{
                    padding: '15px',
                    background: isAdmin ? '#F0FDF4' : '#F3F4F6',
                    borderBottom: '1px solid #e2e8f0'
                  }}>
                    <div style={{ fontSize: '0.85rem', color: '#6B7280', marginBottom: '5px' }}>
                      Connect√© en tant que
                    </div>
                    <div style={{ fontWeight: '600', fontSize: '1rem', color: '#1F2937' }}>
                      {userName}
                    </div>
                    {isAdmin && (
                      <div style={{
                        marginTop: '8px',
                        padding: '4px 10px',
                        background: '#4ADE80',
                        color: 'white',
                        borderRadius: '4px',
                        fontSize: '0.75rem',
                        display: 'inline-block',
                        fontWeight: '600'
                      }}>
                        ‚≠ê Administrateur
                      </div>
                    )}
                  </div>
                  
                  <button
                    onClick={() => {
                      setShowInvoices(true);
                      setMenuOpen(false);
                    }}
                    style={{
                      width: '100%',
                      padding: '15px 20px',
                      background: 'white',
                      border: 'none',
                      borderBottom: '1px solid #e2e8f0',
                      cursor: 'pointer',
                      fontSize: '16px',
                      fontWeight: '600',
                      textAlign: 'left',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px'
                    }}
                  >
                    üí≥ Factures
                  </button>
                  <button
                    onClick={() => {
                      setMenuOpen(false);
                      alert('Param√®tres (√† venir)');
                    }}
                    style={{
                      width: '100%',
                      padding: '15px 20px',
                      background: 'white',
                      border: 'none',
                      borderBottom: '1px solid #e2e8f0',
                      cursor: 'pointer',
                      fontSize: '16px',
                      fontWeight: '600',
                      textAlign: 'left',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px'
                    }}
                  >
                    ‚öôÔ∏è Param√®tres
                  </button>

                  <button
                    onClick={() => {
                      setMenuOpen(false);
                      if (confirm('Se d√©connecter ?')) {
                        onLogout();
                      }
                    }}
                    style={{
                      width: '100%',
                      padding: '15px 20px',
                      background: 'white',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '16px',
                      fontWeight: '600',
                      textAlign: 'left',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      color: '#EF4444'
                    }}
                  >
                    üö™ D√©connexion
                  </button>
                </div>
              </>
            )}

            {/* Onglets optimis√©s mobile */}
            <div style={{
              display: 'flex',
              gap: '8px',
              padding: '0 15px',
              marginBottom: '20px',
              overflowX: 'auto'
            }}>
              {[
                { id: 'inventory', label: 'Inventaire', icon: 'üì¶' },
                { id: 'templates', label: 'Cartons', icon: 'üõí' },
                { id: 'distributions', label: 'Distributions', icon: 'üìÖ' },
                { id: 'stats', label: 'Stats', icon: 'üìä' }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  style={{
                    flex: '1 1 auto',
                    minWidth: '80px',
                    padding: '12px 16px',
                    border: 'none',
                    borderRadius: '12px',
                    background: activeTab === tab.id ? 'white' : 'rgba(255,255,255,0.2)',
                    color: activeTab === tab.id ? '#2E5CFF' : 'white',
                    fontWeight: '700',
                    fontSize: '0.9rem',
                    cursor: 'pointer',
                    whiteSpace: 'nowrap',
                    boxShadow: activeTab === tab.id ? '0 2px 8px rgba(0,0,0,0.15)' : 'none'
                  }}
                >
                  <div>{tab.icon}</div>
                  <div style={{ fontSize: '0.75rem', marginTop: '2px' }}>{tab.label}</div>
                </button>
              ))}
            </div>

            <div style={{ 
              background: 'white', 
              borderRadius: '20px 20px 0 0', 
              padding: '20px 15px',
              minHeight: 'calc(100vh - 200px)'
            }}>
              
              {/* ONGLET INVENTAIRE */}
              {activeTab === 'inventory' && (
                <div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h2 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1a202c' }}>
                      üì¶ Stock actuel
                    </h2>
                    <button
                      onClick={exportInventoryToPDF}
                      style={{
                        padding: '10px 16px',
                        background: '#EF4444',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        fontSize: '14px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}
                    >
                      üìÑ PDF
                    </button>
                  </div>

                  <div style={{
                    background: 'linear-gradient(135deg, #2E5CFF15 0%, #4ADE8015 100%)',
                    padding: '20px',
                    borderRadius: '16px',
                    marginBottom: '20px',
                    border: '2px solid #2E5CFF30'
                  }}>
                    <h3 style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '15px' }}>
                      Ajouter une denr√©e
                    </h3>
                    
                    {/* Layout vertical pour mobile */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      <input
                        type="text"
                        placeholder="Nom de la denr√©e"
                        value={newItem.item_name}
                        onChange={(e) => setNewItem({ ...newItem, item_name: e.target.value })}
                        style={{ 
                          width: '100%', 
                          padding: '14px', 
                          border: '2px solid #cbd5e0', 
                          borderRadius: '10px', 
                          fontSize: '16px'
                        }}
                      />
                      
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '10px' }}>
                        <input
                          type="number"
                          placeholder="Quantit√©"
                          value={newItem.quantity || ''}
                          onChange={(e) => setNewItem({ ...newItem, quantity: parseFloat(e.target.value) || 0 })}
                          style={{ 
                            width: '100%', 
                            padding: '14px', 
                            border: '2px solid #cbd5e0', 
                            borderRadius: '10px', 
                            fontSize: '16px'
                          }}
                        />
                        
                        <input
                          type="text"
                          placeholder="Unit√©"
                          value={newItem.unit}
                          onChange={(e) => setNewItem({ ...newItem, unit: e.target.value })}
                          style={{ 
                            width: '100%', 
                            padding: '14px', 
                            border: '2px solid #cbd5e0', 
                            borderRadius: '10px', 
                            fontSize: '16px'
                          }}
                        />

                        <input
                          type="number"
                          placeholder="Prix ‚Ç¨"
                          step="0.01"
                          value={newItem.price || ''}
                          onChange={(e) => setNewItem({ ...newItem, price: parseFloat(e.target.value) || 0 })}
                          style={{ 
                            width: '100%', 
                            padding: '14px', 
                            border: '2px solid #cbd5e0', 
                            borderRadius: '10px', 
                            fontSize: '16px'
                          }}
                        />
                      </div>
                      
                      <button
                        onClick={addToInventory}
                        disabled={inventorySaving}
                        style={{
                          width: '100%',
                          padding: '16px',
                          background: inventorySaving ? '#cbd5e0' : 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '10px',
                          fontWeight: '700',
                          fontSize: '16px',
                          cursor: inventorySaving ? 'not-allowed' : 'pointer'
                        }}
                      >
                        {inventorySaving ? '‚è≥ Enregistrement...' : '‚ûï Ajouter'}
                      </button>
                    </div>
                  </div>

                  <div>
                    {inventoryLoading ? (
                      <div style={{ textAlign: 'center', padding: '40px 20px' }}>
                        <div style={{
                          display: 'inline-block',
                          width: '40px',
                          height: '40px',
                          border: '4px solid #e2e8f0',
                          borderTop: '4px solid #2E5CFF',
                          borderRadius: '50%',
                          animation: 'spin 1s linear infinite'
                        }}></div>
                        <p style={{ marginTop: '15px', color: '#718096' }}>Chargement du stock...</p>
                        <style>{`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>
                      </div>
                    ) : inventory.length === 0 ? (
                      <p style={{ textAlign: 'center', color: '#a0aec0', padding: '40px 20px', fontSize: '0.95rem' }}>
                        Aucune denr√©e en stock.
                      </p>
                    ) : (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                        {inventory.map((item) => (
                          <div
                            key={item.id}
                            style={{
                              padding: '15px',
                              background: '#f8fafc',
                              borderRadius: '12px',
                              border: '2px solid #e2e8f0'
                            }}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '10px' }}>
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: '600', color: '#1a202c', fontSize: '1rem', marginBottom: '4px' }}>
                                  {item.item_name}
                                </div>
                                <div style={{ fontSize: '0.85rem', color: '#718096' }}>
                                  {item.unit} {item.price > 0 && `‚Ä¢ ${item.price.toFixed(2)}‚Ç¨/${item.unit}`}
                                </div>
                              </div>
                              <div style={{ fontWeight: '700', color: '#2E5CFF', fontSize: '1.4rem' }}>
                                {item.quantity}
                              </div>
                            </div>
                            
                            {editingItem === item.id ? (
                              <div style={{ display: 'flex', gap: '8px', marginTop: '10px' }}>
                                <input
                                  type="number"
                                  defaultValue={item.quantity}
                                  id={`edit-${item.id}`}
                                  style={{ 
                                    flex: 1, 
                                    padding: '10px', 
                                    border: '2px solid #2E5CFF', 
                                    borderRadius: '8px',
                                    fontSize: '16px'
                                  }}
                                />
                                <button
                                  onClick={() => {
                                    const input = document.getElementById(`edit-${item.id}`);
                                    updateInventoryItem(item.id, input.value);
                                  }}
                                  style={{ 
                                    padding: '10px 16px', 
                                    background: '#4ADE80', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '8px', 
                                    cursor: 'pointer',
                                    fontSize: '18px'
                                  }}
                                >
                                  ‚úÖ
                                </button>
                                <button
                                  onClick={() => setEditingItem(null)}
                                  style={{ 
                                    padding: '10px 16px', 
                                    background: '#f56565', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '8px', 
                                    cursor: 'pointer',
                                    fontSize: '18px'
                                  }}
                                >
                                  ‚ùå
                                </button>
                              </div>
                            ) : (
                              <div style={{ display: 'flex', gap: '8px', marginTop: '10px' }}>
                                <button
                                  onClick={() => setEditingItem(item.id)}
                                  style={{ 
                                    flex: 1,
                                    padding: '10px', 
                                    background: '#edf2f7', 
                                    border: 'none', 
                                    borderRadius: '8px', 
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                  }}
                                >
                                  ‚úèÔ∏è Modifier
                                </button>
                                <button
                                  onClick={() => deleteInventoryItem(item.id)}
                                  style={{ 
                                    flex: 1,
                                    padding: '10px', 
                                    background: '#fed7d7', 
                                    border: 'none', 
                                    borderRadius: '8px', 
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600'
                                  }}
                                >
                                  üóëÔ∏è Supprimer
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* ONGLET CARTONS TYPES */}
              {activeTab === 'templates' && (
                <div>
                  <h2 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1a202c', marginBottom: '20px' }}>
                    üõí Mod√®les de cartons
                  </h2>

                  <div style={{
                    background: 'linear-gradient(135deg, #2E5CFF15 0%, #4ADE8015 100%)',
                    padding: '20px',
                    borderRadius: '16px',
                    marginBottom: '20px',
                    border: '2px solid #2E5CFF30'
                  }}>
                    <h3 style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '15px' }}>
                      Cr√©er un nouveau mod√®le
                    </h3>
                    
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      <input
                        type="text"
                        placeholder="Nom du mod√®le (ex: Carton Famille)"
                        value={newTemplate.template_name}
                        onChange={(e) => setNewTemplate({ ...newTemplate, template_name: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '14px',
                          border: '2px solid #cbd5e0',
                          borderRadius: '10px',
                          fontSize: '16px'
                        }}
                      />
                      
                      <textarea
                        placeholder="Description (optionnel)"
                        value={newTemplate.description}
                        onChange={(e) => setNewTemplate({ ...newTemplate, description: e.target.value })}
                        style={{
                          width: '100%',
                          padding: '14px',
                          border: '2px solid #cbd5e0',
                          borderRadius: '10px',
                          minHeight: '60px',
                          resize: 'vertical',
                          fontSize: '16px'
                        }}
                      />

                      <div style={{ 
                        background: 'white', 
                        padding: '15px', 
                        borderRadius: '10px',
                        marginTop: '10px'
                      }}>
                        <h4 style={{ fontSize: '0.9rem', fontWeight: '600', marginBottom: '10px' }}>
                          Ajouter des denr√©es :
                        </h4>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          <input
                            type="text"
                            placeholder="Denr√©e"
                            value={newTemplateItem.item_name}
                            onChange={(e) => setNewTemplateItem({ ...newTemplateItem, item_name: e.target.value })}
                            style={{ 
                              width: '100%',
                              padding: '12px', 
                              border: '2px solid #cbd5e0', 
                              borderRadius: '8px',
                              fontSize: '16px'
                            }}
                          />
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr auto', gap: '8px' }}>
                            <input
                              type="number"
                              placeholder="Quantit√©"
                              value={newTemplateItem.quantity || ''}
                              onChange={(e) => setNewTemplateItem({ ...newTemplateItem, quantity: parseFloat(e.target.value) || 0 })}
                              style={{ 
                                padding: '12px', 
                                border: '2px solid #cbd5e0', 
                                borderRadius: '8px',
                                fontSize: '16px'
                              }}
                            />
                            <button
                              onClick={addToNewTemplate}
                              style={{
                                padding: '12px 20px',
                                background: '#2E5CFF',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                fontWeight: '700',
                                cursor: 'pointer',
                                fontSize: '18px'
                              }}
                            >
                              ‚ûï
                            </button>
                          </div>
                        </div>
                      </div>

                      {newTemplate.items.length > 0 && (
                        <div style={{ background: 'white', padding: '15px', borderRadius: '10px' }}>
                          <h4 style={{ fontSize: '0.9rem', fontWeight: '600', marginBottom: '10px' }}>
                            Contenu du carton :
                          </h4>
                          {newTemplate.items.map((item, index) => (
                            <div
                              key={index}
                              style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: '10px',
                                background: '#f7fafc',
                                borderRadius: '8px',
                                marginBottom: '8px'
                              }}
                            >
                              <span style={{ fontSize: '0.95rem' }}>
                                {item.item_name} - <strong>{item.quantity}</strong>
                              </span>
                              <button
                                onClick={() => removeFromNewTemplate(index)}
                                style={{ 
                                  padding: '6px 12px', 
                                  background: '#fed7d7', 
                                  border: 'none', 
                                  borderRadius: '6px', 
                                  cursor: 'pointer',
                                  fontSize: '16px'
                                }}
                              >
                                ‚ùå
                              </button>
                            </div>
                          ))}
                        </div>
                      )}

                      <button
                        onClick={saveBoxTemplate}
                        disabled={!newTemplate.template_name || newTemplate.items.length === 0}
                        style={{
                          width: '100%',
                          padding: '16px',
                          background: newTemplate.template_name && newTemplate.items.length > 0
                            ? 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)'
                            : '#cbd5e0',
                          color: 'white',
                          border: 'none',
                          borderRadius: '10px',
                          fontWeight: '700',
                          fontSize: '16px',
                          cursor: newTemplate.template_name && newTemplate.items.length > 0 ? 'pointer' : 'not-allowed',
                          marginTop: '10px'
                        }}
                      >
                        üíæ Enregistrer le mod√®le
                      </button>
                    </div>
                  </div>

                  <div>
                    {boxTemplates.length === 0 ? (
                      <p style={{ textAlign: 'center', color: '#a0aec0', padding: '40px 20px', fontSize: '0.95rem' }}>
                        Aucun mod√®le cr√©√©.
                      </p>
                    ) : (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                        {boxTemplates.map((template) => (
                          <div
                            key={template.id}
                            style={{
                              background: '#f8fafc',
                              borderRadius: '12px',
                              border: '2px solid #e2e8f0',
                              padding: '15px'
                            }}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '15px' }}>
                              <div style={{ flex: 1 }}>
                                <h3 style={{ fontSize: '1.1rem', fontWeight: '700', marginBottom: '5px' }}>
                                  {template.template_name}
                                </h3>
                                {template.description && (
                                  <p style={{ fontSize: '0.85rem', color: '#718096' }}>
                                    {template.description}
                                  </p>
                                )}
                              </div>
                              <button
                                onClick={() => deleteBoxTemplate(template.id)}
                                style={{ 
                                  padding: '8px 12px', 
                                  background: '#fed7d7', 
                                  border: 'none', 
                                  borderRadius: '8px', 
                                  cursor: 'pointer',
                                  height: 'fit-content',
                                  fontSize: '16px'
                                }}
                              >
                                üóëÔ∏è
                              </button>
                            </div>

                            <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                              <button
                                onClick={() => generateBoxPDF(template)}
                                style={{
                                  flex: 1,
                                  padding: '14px',
                                  background: 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '10px',
                                  fontWeight: '700',
                                  fontSize: '15px',
                                  cursor: 'pointer'
                                }}
                              >
                                üìÑ PDF
                              </button>
                              <button
                                onClick={() => {
                                  setNewTemplate({
                                    template_name: template.template_name,
                                    description: template.description || '',
                                    items: [...template.items]
                                  });
                                  deleteBoxTemplate(template.id);
                                  window.scrollTo({ top: 0, behavior: 'smooth' });
                                  alert('‚úèÔ∏è Modifiez le carton ci-dessus, puis enregistrez-le');
                                }}
                                style={{
                                  flex: 1,
                                  padding: '14px',
                                  background: '#edf2f7',
                                  color: '#2E5CFF',
                                  border: '2px solid #2E5CFF',
                                  borderRadius: '10px',
                                  fontWeight: '700',
                                  fontSize: '15px',
                                  cursor: 'pointer'
                                }}
                              >
                                ‚úèÔ∏è Modifier
                              </button>
                            </div>
                            <div style={{ background: 'white', borderRadius: '10px', padding: '12px' }}>
                              {template.items.map((item, index) => (
                                <div
                                  key={index}
                                  style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    padding: '8px 0',
                                    borderBottom: index < template.items.length - 1 ? '1px solid #e2e8f0' : 'none',
                                    fontSize: '0.95rem'
                                  }}
                                >
                                  <span>{item.item_name}</span>
                                  <span style={{ fontWeight: '700', color: '#2E5CFF' }}>{item.quantity}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* ONGLET DISTRIBUTIONS */}
              {activeTab === 'distributions' && (
                <div>
                  <h2 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1a202c', marginBottom: '20px' }}>
                    üìÖ Distributions
                  </h2>

                  <div style={{
                    background: 'linear-gradient(135deg, #2E5CFF15 0%, #4ADE8015 100%)',
                    padding: '20px',
                    borderRadius: '16px',
                    marginBottom: '20px',
                    border: '2px solid #2E5CFF30'
                  }}>
                    <h3 style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '15px' }}>
                      Planifier une distribution
                    </h3>
                    
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      <select
                        value={newDistribution.template_id}
                        onChange={(e) => setNewDistribution({ ...newDistribution, template_id: e.target.value })}
                        style={{ 
                          width: '100%',
                          padding: '14px', 
                          border: '2px solid #cbd5e0', 
                          borderRadius: '10px', 
                          background: 'white',
                          fontSize: '16px'
                        }}
                      >
                        <option value="">S√©lectionner un mod√®le de carton</option>
                        {boxTemplates.map(template => (
                          <option key={template.id} value={template.id}>{template.template_name}</option>
                        ))}
                      </select>
                      
                      <input
                        type="date"
                        value={newDistribution.distribution_date}
                        onChange={(e) => setNewDistribution({ ...newDistribution, distribution_date: e.target.value })}
                        style={{ 
                          width: '100%',
                          padding: '14px', 
                          border: '2px solid #cbd5e0', 
                          borderRadius: '10px',
                          fontSize: '16px'
                        }}
                      />
                      
                      <input
                        type="number"
                        placeholder="Nombre de cartons"
                        value={newDistribution.box_count || ''}
                        onChange={(e) => setNewDistribution({ ...newDistribution, box_count: parseInt(e.target.value) || 0 })}
                        style={{ 
                          width: '100%',
                          padding: '14px', 
                          border: '2px solid #cbd5e0', 
                          borderRadius: '10px',
                          fontSize: '16px'
                        }}
                      />
                      
                      <input
                        type="text"
                        placeholder="Notes (optionnel)"
                        value={newDistribution.notes}
                        onChange={(e) => setNewDistribution({ ...newDistribution, notes: e.target.value })}
                        style={{ 
                          width: '100%',
                          padding: '14px', 
                          border: '2px solid #cbd5e0', 
                          borderRadius: '10px',
                          fontSize: '16px'
                        }}
                      />

                      <button
                        onClick={createDistribution}
                        disabled={!newDistribution.template_id || !newDistribution.distribution_date || !newDistribution.box_count}
                        style={{
                          width: '100%',
                          padding: '16px',
                          background: newDistribution.template_id && newDistribution.distribution_date && newDistribution.box_count
                            ? 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)'
                            : '#cbd5e0',
                          color: 'white',
                          border: 'none',
                          borderRadius: '10px',
                          fontWeight: '700',
                          fontSize: '16px',
                          cursor: newDistribution.template_id && newDistribution.distribution_date && newDistribution.box_count ? 'pointer' : 'not-allowed'
                        }}
                      >
                        üìÖ Planifier la distribution
                      </button>
                    </div>
                  </div>

                  <div>
                    {distributions.length === 0 ? (
                      <p style={{ textAlign: 'center', color: '#a0aec0', padding: '40px 20px', fontSize: '0.95rem' }}>
                        Aucune distribution planifi√©e.
                      </p>
                    ) : (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                        {distributions.map((dist) => (
                          <div
                            key={dist.id}
                            style={{
                              background: '#EBF8FF',
                              border: '2px solid #2E5CFF',
                              borderRadius: '12px',
                              padding: '15px'
                            }}
                          >
                            <div style={{ marginBottom: '15px' }}>
                              <h3 style={{ fontSize: '1.1rem', fontWeight: '700', marginBottom: '8px' }}>
                                {dist.template_name}
                              </h3>
                              <div style={{ fontSize: '0.9rem', color: '#4a5568' }}>
                                <div>üìÖ {new Date(dist.distribution_date).toLocaleDateString('fr-FR')}</div>
                                <div>üì¶ {dist.box_count} cartons</div>
                                {dist.notes && <div style={{ marginTop: '5px' }}>üìù {dist.notes}</div>}
                              </div>
                            </div>
                            
                            <div style={{ display: 'flex', gap: '8px' }}>
                              <button
                                onClick={() => viewDistributionNeeds(dist.id)}
                                style={{
                                  flex: 1,
                                  padding: '12px',
                                  background: 'white',
                                  border: '2px solid #2E5CFF',
                                  borderRadius: '8px',
                                  fontWeight: '600',
                                  cursor: 'pointer',
                                  fontSize: '14px'
                                }}
                              >
                                ‚ö†Ô∏è Voir les besoins
                              </button>
                              <button
                                onClick={() => deleteDistribution(dist.id)}
                                style={{ 
                                  padding: '12px 16px', 
                                  background: 'white', 
                                  border: '2px solid #fed7d7', 
                                  borderRadius: '8px', 
                                  cursor: 'pointer',
                                  fontSize: '16px'
                                }}
                              >
                                üóëÔ∏è
                              </button>
                            </div>

                            {selectedDistribution === dist.id && distributionNeeds.length > 0 && (
                              <div style={{ background: 'white', borderRadius: '10px', padding: '15px', marginTop: '15px' }}>
                                <h4 style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '12px' }}>
                                  üìä Analyse des besoins
                                </h4>
                                
                                {(() => {
                                  const totalMissing = distributionNeeds.reduce((sum, need) => sum + need.missingCost, 0);
                                  return totalMissing > 0 && (
                                    <div style={{
                                      background: '#FEF2F2',
                                      border: '2px solid #EF4444',
                                      borderRadius: '10px',
                                      padding: '15px',
                                      marginBottom: '15px'
                                    }}>
                                      <div style={{ fontSize: '0.9rem', fontWeight: '600', marginBottom: '5px' }}>
                                        üí∞ Budget manquant
                                      </div>
                                      <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#DC2626' }}>
                                        {totalMissing.toFixed(2)} ‚Ç¨
                                      </div>
                                    </div>
                                  );
                                })()}
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                  {distributionNeeds.map((need, index) => (
                                    <div
                                      key={index}
                                      style={{
                                        padding: '12px',
                                        background: need.sufficient ? '#F0FDF4' : '#FEF2F2',
                                        border: `2px solid ${need.sufficient ? '#4ADE80' : '#EF4444'}`,
                                        borderRadius: '8px'
                                      }}
                                    >
                                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '5px' }}>
                                        <span style={{ fontWeight: '600', fontSize: '0.95rem' }}>
                                          {need.sufficient ? '‚úÖ' : '‚ö†Ô∏è'} {need.item_name}
                                        </span>
                                        {!need.sufficient && (
                                          <div style={{ textAlign: 'right' }}>
                                            <div style={{ fontWeight: '700', color: '#DC2626', fontSize: '1.1rem' }}>
                                              -{need.missing}
                                            </div>
                                            {need.price > 0 && (
                                              <div style={{ fontSize: '0.85rem', color: '#DC2626', fontWeight: '600' }}>
                                                {need.missingCost.toFixed(2)} ‚Ç¨
                                              </div>
                                            )}
                                          </div>
                                        )}
                                      </div>
                                      <div style={{ fontSize: '0.8rem', color: '#4a5568' }}>
                                        Besoin: {need.total_needed} | Disponible: {need.available}
                                        {need.price > 0 && ` | ${need.price.toFixed(2)} ‚Ç¨/unit√©`}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* ONGLET STATISTIQUES */}
              {activeTab === 'stats' && (
                <div>
                  <h2 style={{ fontSize: '1.5rem', fontWeight: '700', color: '#1a202c', marginBottom: '20px' }}>
                    üìä Statistiques
                  </h2>

                  {/* Compteurs */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '15px',
                    marginBottom: '20px'
                  }}>
                    <div style={{
                      padding: '20px',
                      background: 'linear-gradient(135deg, #2E5CFF 0%, #1E40AF 100%)',
                      borderRadius: '12px',
                      color: 'white'
                    }}>
                      <div style={{ fontSize: '0.85rem', marginBottom: '5px', opacity: 0.9 }}>
                        üì¶ Articles en stock
                      </div>
                      <div style={{ fontSize: '2rem', fontWeight: '700' }}>
                        {inventory.length}
                      </div>
                    </div>

                    <div style={{
                      padding: '20px',
                      background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
                      borderRadius: '12px',
                      color: 'white'
                    }}>
                      <div style={{ fontSize: '0.85rem', marginBottom: '5px', opacity: 0.9 }}>
                        üõí Mod√®les de cartons
                      </div>
                      <div style={{ fontSize: '2rem', fontWeight: '700' }}>
                        {boxTemplates.length}
                      </div>
                    </div>

                    <div style={{
                      padding: '20px',
                      background: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)',
                      borderRadius: '12px',
                      color: 'white'
                    }}>
                      <div style={{ fontSize: '0.85rem', marginBottom: '5px', opacity: 0.9 }}>
                        üìÖ Distributions
                      </div>
                      <div style={{ fontSize: '2rem', fontWeight: '700' }}>
                        {distributions.length}
                      </div>
                    </div>

                    <div style={{
                      padding: '20px',
                      background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)',
                      borderRadius: '12px',
                      color: 'white'
                    }}>
                      <div style={{ fontSize: '0.85rem', marginBottom: '5px', opacity: 0.9 }}>
                        üí≥ Factures
                      </div>
                      <div style={{ fontSize: '2rem', fontWeight: '700' }}>
                        {invoices.length}
                      </div>
                    </div>
                  </div>

                  {/* Valeur totale du stock */}
                  <div style={{
                    padding: '20px',
                    background: '#F0FDF4',
                    border: '2px solid #4ADE80',
                    borderRadius: '12px',
                    marginBottom: '20px'
                  }}>
                    <div style={{ fontSize: '0.9rem', color: '#166534', marginBottom: '10px' }}>
                      üí∞ Valeur totale du stock
                    </div>
                    <div style={{ fontSize: '2.5rem', fontWeight: '700', color: '#15803D' }}>
                      {inventory.reduce((sum, item) => sum + (item.quantity * (item.price || 0)), 0).toFixed(2)} ‚Ç¨
                    </div>
                  </div>

                  {/* Top 5 articles */}
                  <div style={{
                    padding: '20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 10px rgba(0,0,0,0.1)',
                    border: '1px solid #e2e8f0'
                  }}>
                    <h3 style={{ marginBottom: '15px', color: '#374151', fontSize: '1.1rem' }}>
                      üèÜ Top 5 articles (par quantit√©)
                    </h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      {inventory.length === 0 ? (
                        <p style={{ color: '#9CA3AF', textAlign: 'center', padding: '20px' }}>
                          Aucun article en stock
                        </p>
                      ) : (
                        [...inventory]
                          .sort((a, b) => b.quantity - a.quantity)
                          .slice(0, 5)
                          .map((item, index) => (
                            <div
                              key={item.id}
                              style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: '12px',
                                background: '#F9FAFB',
                                borderRadius: '8px'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <div style={{
                                  width: '30px',
                                  height: '30px',
                                  background: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#E5E7EB',
                                  borderRadius: '50%',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  fontWeight: '700',
                                  color: index < 3 ? 'white' : '#6B7280',
                                  fontSize: '0.85rem'
                                }}>
                                  {index + 1}
                                </div>
                                <span style={{ fontWeight: '600' }}>{item.item_name}</span>
                              </div>
                              <span style={{ fontWeight: '700', color: '#2E5CFF' }}>
                                {item.quantity} {item.unit}
                              </span>
                            </div>
                          ))
                      )}
                    </div>
                  </div>

                  {/* Articles √† faible stock */}
                  <div style={{
                    padding: '20px',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 2px 10px rgba(0,0,0,0.1)',
                    border: '1px solid #e2e8f0',
                    marginTop: '20px'
                  }}>
                    <h3 style={{ marginBottom: '15px', color: '#DC2626', fontSize: '1.1rem' }}>
                      ‚ö†Ô∏è Stock faible (moins de 10)
                    </h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      {inventory.filter(item => item.quantity < 10).length === 0 ? (
                        <p style={{ color: '#10B981', textAlign: 'center', padding: '20px' }}>
                          ‚úÖ Tous les stocks sont suffisants
                        </p>
                      ) : (
                        inventory
                          .filter(item => item.quantity < 10)
                          .sort((a, b) => a.quantity - b.quantity)
                          .map((item) => (
                            <div
                              key={item.id}
                              style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: '12px',
                                background: '#FEF2F2',
                                borderRadius: '8px',
                                border: '1px solid #FECACA'
                              }}
                            >
                              <span style={{ fontWeight: '600', color: '#991B1B' }}>{item.item_name}</span>
                              <span style={{ fontWeight: '700', color: '#DC2626' }}>
                                {item.quantity} {item.unit}
                              </span>
                            </div>
                          ))
                      )}
                    </div>
                  </div>
                </div>
              )}

            </div>

            {/* INTERFACE FACTURES - MODALE PLEIN √âCRAN */}
            {showInvoices && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'white',
                zIndex: 1000,
                overflowY: 'auto'
              }}>
                <div style={{
                  minHeight: '100vh',
                  background: 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)',
                  paddingBottom: '20px'
                }}>
                  <header style={{
                    padding: '15px 20px',
                    color: 'white',
                    background: 'rgba(0,0,0,0.1)',
                    marginBottom: '20px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '15px'
                  }}>
                    <button
                      onClick={() => setShowInvoices(false)}
                      style={{
                        padding: '10px',
                        background: 'rgba(255,255,255,0.25)',
                        color: 'white',
                        border: '2px solid rgba(255,255,255,0.5)',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontSize: '24px',
                        lineHeight: '1',
                        width: '48px',
                        height: '48px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}
                    >
                      ‚Üê
                    </button>
                    <div style={{ flex: 1 }}>
                      <h1 style={{ fontSize: '1.5rem', fontWeight: '800' }}>
                        üí≥ Factures
                      </h1>
                    </div>
                  </header>

                  <div style={{
                    background: 'white',
                    borderRadius: '20px 20px 0 0',
                    padding: '20px 15px',
                    minHeight: 'calc(100vh - 100px)'
                  }}>
                    
                    {/* FORMULAIRE NOUVELLE FACTURE */}
                    <div style={{
                      background: 'linear-gradient(135deg, #2E5CFF15 0%, #4ADE8015 100%)',
                      padding: '20px',
                      borderRadius: '16px',
                      marginBottom: '20px',
                      border: '2px solid #2E5CFF30'
                    }}>
                      <h3 style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '15px' }}>
                        Nouvelle facture
                      </h3>
                      
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                        <input
                          type="text"
                          placeholder="Fournisseur (ex: Carrefour)"
                          value={newInvoice.supplier}
                          onChange={(e) => setNewInvoice({ ...newInvoice, supplier: e.target.value })}
                          style={{
                            width: '100%',
                            padding: '14px',
                            border: '2px solid #cbd5e0',
                            borderRadius: '10px',
                            fontSize: '16px'
                          }}
                        />
                        
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                          <input
                            type="text"
                            placeholder="N¬∞ facture"
                            value={newInvoice.invoice_number}
                            onChange={(e) => setNewInvoice({ ...newInvoice, invoice_number: e.target.value })}
                            style={{
                              width: '100%',
                              padding: '14px',
                              border: '2px solid #cbd5e0',
                              borderRadius: '10px',
                              fontSize: '16px'
                            }}
                          />
                          
                          <input
                            type="date"
                            value={newInvoice.invoice_date}
                            onChange={(e) => setNewInvoice({ ...newInvoice, invoice_date: e.target.value })}
                            style={{
                              width: '100%',
                              padding: '14px',
                              border: '2px solid #cbd5e0',
                              borderRadius: '10px',
                              fontSize: '16px'
                            }}
                          />
                        </div>

                        <div style={{ background: 'white', padding: '15px', borderRadius: '10px' }}>
                          <h4 style={{ fontSize: '0.9rem', fontWeight: '600', marginBottom: '10px' }}>
                            üìé Joindre la facture :
                          </h4>
                          <input
                            type="file"
                            accept="image/*,application/pdf"
                            onChange={handleInvoiceFileUpload}
                            style={{
                              width: '100%',
                              padding: '12px',
                              border: '2px solid #cbd5e0',
                              borderRadius: '8px',
                              fontSize: '16px'
                            }}
                          />
                          {newInvoice.file && (
                            <div style={{ marginTop: '10px', fontSize: '0.9rem', color: '#4ADE80' }}>
                              ‚úÖ {newInvoice.file}
                            </div>
                          )}
                        </div>

                        <div style={{ background: 'white', padding: '15px', borderRadius: '10px' }}>
                          <h4 style={{ fontSize: '0.9rem', fontWeight: '600', marginBottom: '10px' }}>
                            Ajouter les articles :
                          </h4>
                          <input
                            type="text"
                            placeholder="Nom de l'article"
                            value={newInvoiceItem.item_name}
                            onChange={(e) => setNewInvoiceItem({ ...newInvoiceItem, item_name: e.target.value })}
                            list="inventory-items"
                            style={{
                              width: '100%',
                              padding: '12px',
                              border: '2px solid #cbd5e0',
                              borderRadius: '8px',
                              fontSize: '16px',
                              marginBottom: '8px'
                            }}
                          />
                          <datalist id="inventory-items">
                            {inventory.map((item, idx) => (
                              <option key={idx} value={item.item_name} />
                            ))}
                          </datalist>
                          
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', marginBottom: '8px' }}>
                            <input
                              type="number"
                              placeholder="Qt√©"
                              value={newInvoiceItem.quantity || ''}
                              onChange={(e) => setNewInvoiceItem({ ...newInvoiceItem, quantity: parseFloat(e.target.value) || 0 })}
                              style={{
                                padding: '12px',
                                border: '2px solid #cbd5e0',
                                borderRadius: '8px',
                                fontSize: '16px'
                              }}
                            />
                            <input
                              type="text"
                              placeholder="Unit√©"
                              value={newInvoiceItem.unit}
                              onChange={(e) => setNewInvoiceItem({ ...newInvoiceItem, unit: e.target.value })}
                              style={{
                                padding: '12px',
                                border: '2px solid #cbd5e0',
                                borderRadius: '8px',
                                fontSize: '16px'
                              }}
                            />
                            <input
                              type="number"
                              placeholder="Prix ‚Ç¨"
                              step="0.01"
                              value={newInvoiceItem.price || ''}
                              onChange={(e) => setNewInvoiceItem({ ...newInvoiceItem, price: parseFloat(e.target.value) || 0 })}
                              style={{
                                padding: '12px',
                                border: '2px solid #cbd5e0',
                                borderRadius: '8px',
                                fontSize: '16px'
                              }}
                            />
                          </div>
                          <button
                            onClick={addToNewInvoice}
                            style={{
                              width: '100%',
                              padding: '12px',
                              background: '#2E5CFF',
                              color: 'white',
                              border: 'none',
                              borderRadius: '8px',
                              fontWeight: '700',
                              cursor: 'pointer',
                              fontSize: '16px'
                            }}
                          >
                            ‚ûï Ajouter
                          </button>
                        </div>

                        {newInvoice.items.length > 0 && (
                          <div style={{ background: 'white', padding: '15px', borderRadius: '10px' }}>
                            <h4 style={{ fontSize: '0.9rem', fontWeight: '600', marginBottom: '10px' }}>
                              Articles ({newInvoice.items.length}) :
                            </h4>
                            {newInvoice.items.map((item, index) => (
                              <div
                                key={index}
                                style={{
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                  padding: '10px',
                                  background: '#f7fafc',
                                  borderRadius: '8px',
                                  marginBottom: '8px'
                                }}
                              >
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontWeight: '600', fontSize: '0.95rem' }}>
                                    {item.item_name}
                                  </div>
                                  <div style={{ fontSize: '0.85rem', color: '#718096' }}>
                                    {item.quantity} {item.unit} √ó {item.price.toFixed(2)}‚Ç¨ = {(item.quantity * item.price).toFixed(2)}‚Ç¨
                                  </div>
                                </div>
                                <button
                                  onClick={() => removeFromNewInvoice(index)}
                                  style={{
                                    padding: '6px 12px',
                                    background: '#fed7d7',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '16px'
                                  }}
                                >
                                  ‚ùå
                                </button>
                              </div>
                            ))}
                            
                            <div style={{
                              marginTop: '15px',
                              padding: '15px',
                              background: '#EBF8FF',
                              borderRadius: '8px',
                              border: '2px solid #2E5CFF'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span style={{ fontSize: '1.1rem', fontWeight: '700' }}>Total TTC :</span>
                                <span style={{ fontSize: '1.5rem', fontWeight: '700', color: '#2E5CFF' }}>
                                  {newInvoice.total.toFixed(2)} ‚Ç¨
                                </span>
                              </div>
                            </div>
                          </div>
                        )}

                        <textarea
                          placeholder="Notes (optionnel)"
                          value={newInvoice.notes}
                          onChange={(e) => setNewInvoice({ ...newInvoice, notes: e.target.value })}
                          style={{
                            width: '100%',
                            padding: '14px',
                            border: '2px solid #cbd5e0',
                            borderRadius: '10px',
                            minHeight: '60px',
                            resize: 'vertical',
                            fontSize: '16px'
                          }}
                        />

                        <button
                          onClick={saveInvoice}
                          disabled={!newInvoice.supplier || !newInvoice.invoice_date || newInvoice.items.length === 0}
                          style={{
                            width: '100%',
                            padding: '16px',
                            background: newInvoice.supplier && newInvoice.invoice_date && newInvoice.items.length > 0
                              ? 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)'
                              : '#cbd5e0',
                            color: 'white',
                            border: 'none',
                            borderRadius: '10px',
                            fontWeight: '700',
                            fontSize: '16px',
                            cursor: newInvoice.supplier && newInvoice.invoice_date && newInvoice.items.length > 0 ? 'pointer' : 'not-allowed'
                          }}
                        >
                          üíæ Enregistrer
                        </button>
                      </div>
                    </div>

                    {/* LISTE DES FACTURES */}
                    <div>
                      {invoices.length === 0 ? (
                        <p style={{ textAlign: 'center', color: '#a0aec0', padding: '40px 20px' }}>
                          Aucune facture enregistr√©e.
                        </p>
                      ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                          {invoices.map((invoice) => (
                            <div
                              key={invoice.id}
                              style={{
                                background: '#f8fafc',
                                borderRadius: '12px',
                                border: '2px solid #e2e8f0',
                                padding: '15px'
                              }}
                            >
                              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <div style={{ flex: 1 }}>
                                  <h3 style={{ fontSize: '1.1rem', fontWeight: '700', marginBottom: '5px' }}>
                                    üè™ {invoice.supplier}
                                  </h3>
                                  <div style={{ fontSize: '0.85rem', color: '#718096' }}>
                                    üìÖ {new Date(invoice.invoice_date).toLocaleDateString('fr-FR')}
                                    {invoice.invoice_number && ` ‚Ä¢ N¬∞ ${invoice.invoice_number}`}
                                  </div>
                                  <div style={{ fontSize: '1rem', fontWeight: '700', color: '#2E5CFF', marginTop: '5px' }}>
                                    üí∞ {invoice.total.toFixed(2)} ‚Ç¨
                                  </div>
                                </div>
                                <button
                                  onClick={() => deleteInvoice(invoice.id)}
                                  style={{
                                    padding: '8px 12px',
                                    background: '#fed7d7',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    height: 'fit-content',
                                    fontSize: '16px'
                                  }}
                                >
                                  üóëÔ∏è
                                </button>
                              </div>

                              {invoice.file && (
                                <div style={{
                                  background: 'white',
                                  padding: '10px',
                                  borderRadius: '8px',
                                  marginBottom: '10px',
                                  fontSize: '0.9rem'
                                }}>
                                  üìé {invoice.file}
                                  {invoice.fileData && (
                                    <a
                                      href={invoice.fileData}
                                      download={invoice.file}
                                      style={{
                                        marginLeft: '10px',
                                        color: '#2E5CFF',
                                        fontWeight: '600'
                                      }}
                                    >
                                      üì• T√©l√©charger
                                    </a>
                                  )}
                                </div>
                              )}

                              <div style={{ background: 'white', borderRadius: '8px', padding: '10px', marginBottom: '10px' }}>
                                {invoice.items.map((item, idx) => (
                                  <div
                                    key={idx}
                                    style={{
                                      display: 'flex',
                                      justifyContent: 'space-between',
                                      padding: '6px 0',
                                      borderBottom: idx < invoice.items.length - 1 ? '1px solid #e2e8f0' : 'none',
                                      fontSize: '0.9rem'
                                    }}
                                  >
                                    <span>{item.item_name} ({item.quantity} {item.unit})</span>
                                    <span style={{ fontWeight: '700', color: '#2E5CFF' }}>
                                      {(item.quantity * item.price).toFixed(2)}‚Ç¨
                                    </span>
                                  </div>
                                ))}
                              </div>

                              <button
                                onClick={() => addInvoiceToStock(invoice)}
                                disabled={invoice.addedToStock}
                                style={{
                                  width: '100%',
                                  padding: '14px',
                                  background: invoice.addedToStock
                                    ? '#cbd5e0'
                                    : 'linear-gradient(135deg, #2E5CFF 0%, #4ADE80 100%)',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '10px',
                                  fontWeight: '700',
                                  fontSize: '15px',
                                  cursor: invoice.addedToStock ? 'not-allowed' : 'pointer'
                                }}
                              >
                                {invoice.addedToStock ? '‚úÖ Ajout√© au stock' : 'üì¶ Ajouter au stock'}
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                  </div>
                </div>
              </div>
            )}

          </div>
        </div>
      );
    }


    function LoginPage({ onSuccess }) {
      const [pin, setPin] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          const response = await fetch(API_URL + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin }),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            localStorage.setItem('ba_token', data.token);
            localStorage.setItem('ba_logged_in', 'true');
            localStorage.setItem('ba_role', data.role || 'user');
            localStorage.setItem('ba_user_name', data.name || 'Utilisateur');
            onSuccess();
          } else {
            setError(data.error || 'PIN incorrect');
          }
        } catch (err) {
          setError('Erreur de connexion au serveur');
        } finally {
          setLoading(false);
        }
      };

      return React.createElement('div', {
        style: {
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
        }
      },
        React.createElement('div', {
          style: {
            background: 'white',
            padding: '40px',
            borderRadius: '20px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            maxWidth: '400px',
            width: '100%'
          }
        },
          // Header
          React.createElement('div', { style: { textAlign: 'center', marginBottom: '30px' } },
            React.createElement('h1', {
              style: { color: '#2E5CFF', fontSize: '28px', marginBottom: '10px', fontWeight: '600' }
            }, 'üçé Banque Alimentaire'),
            React.createElement('p', { style: { color: '#666', fontSize: '14px' } }, 'Fontenay-sous-Bois')
          ),

          // Erreur
          error && React.createElement('div', {
            style: {
              background: '#fee',
              color: '#c33',
              padding: '12px',
              borderRadius: '8px',
              marginBottom: '20px',
              fontSize: '14px',
              textAlign: 'center'
            }
          }, error),

          // Formulaire
          React.createElement('form', { onSubmit: handleSubmit },
            React.createElement('div', { style: { marginBottom: '20px' } },
              React.createElement('label', {
                style: {
                  display: 'block',
                  marginBottom: '8px',
                  color: '#333',
                  fontWeight: '500'
                }
              }, 'Code PIN'),
              React.createElement('input', {
                type: 'password',
                value: pin,
                onChange: (e) => setPin(e.target.value),
                placeholder: 'Entrez votre code PIN',
                maxLength: 10,
                autoFocus: true,
                disabled: loading,
                style: {
                  width: '100%',
                  padding: '12px',
                  border: '2px solid #e0e0e0',
                  borderRadius: '8px',
                  fontSize: '16px',
                  outline: 'none',
                  transition: 'border-color 0.3s'
                }
              })
            ),

            React.createElement('button', {
              type: 'submit',
              disabled: loading || !pin,
              style: {
                width: '100%',
                padding: '14px',
                background: loading || !pin ? '#ccc' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: loading || !pin ? 'not-allowed' : 'pointer',
                transition: 'transform 0.2s'
              }
            }, loading ? 'Connexion...' : 'Se connecter')
          ),

          // Info PIN
          React.createElement('div', {
            style: {
              marginTop: '20px',
              textAlign: 'center',
              fontSize: '12px',
              color: '#999'
            }
          }, 'PIN par d√©faut : 1234')
        )
      );
    }

    // ========== APP AVEC AUTH ==========
    function AppWithAuth() {
      const [isAuth, setIsAuth] = React.useState(false);
      const [checking, setChecking] = React.useState(true);

      React.useEffect(() => {
        const token = localStorage.getItem('ba_token');
        const logged = localStorage.getItem('ba_logged_in');
        if (token && logged === 'true') {
          setIsAuth(true);
        }
        setChecking(false);
      }, []);

      if (checking) {
        return React.createElement('div', {
          style: { textAlign: 'center', padding: '50px', fontFamily: 'sans-serif' }
        }, 'Chargement...');
      }

      if (!isAuth) {
        return React.createElement(LoginPage, { onSuccess: () => setIsAuth(true) });
      }

      return React.createElement(BanqueAlimentaireApp, { 
        onLogout: () => {
          localStorage.removeItem('ba_token');
          localStorage.removeItem('ba_logged_in');
          localStorage.removeItem('ba_role');
          localStorage.removeItem('ba_user_name');
          setIsAuth(false);
        }
      });
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(AppWithAuth));
  </script>
</body>
</html>
